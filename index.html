<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đàn Piano Ảo Chuyên Nghiệp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --white-key-color: #f8f8f8;
      --white-key-active: #e0e0e0;
      --black-key-color: #222;
      --black-key-active: #555;
      --piano-border: #996633;
      --wood-color: #8B4513;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    
    .app-container {
      width: 100%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    header {
      width: 100%;
      text-align: center;
      padding: 20px 0;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      background: linear-gradient(to right, #cca352, #e6c171);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      width: 100%;
      margin: 10px 0 25px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .control-label {
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    select, button {
      padding: 8px 12px;
      border-radius: 5px;
      border: none;
      background-color: #2e3852;
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    select:hover, button:hover {
      background-color: #3a4566;
    }
    
    button {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    button.active {
      background-color: #4CAF50;
    }
    
    .piano-container {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 20px auto;
      perspective: 1000px;
    }
    
    .piano-top {
      height: 30px;
      background: var(--wood-color);
      border-radius: 10px 10px 0 0;
      border: 2px solid var(--piano-border);
      border-bottom: none;
      box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.4);
    }
    
    .piano {
      display: flex;
      position: relative;
      background: var(--wood-color);
      padding: 15px 10px 0;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      border: 2px solid var(--piano-border);
      transform-style: preserve-3d;
      transform: rotateX(5deg);
      width: 100%;
      overflow-x: auto;
    }
    
    .white-keys {
      display: flex;
      position: relative;
      z-index: 1;
      width: 100%;
      min-width: 800px;
    }
    
    .black-keys {
      position: absolute;
      top: 15px;
      left: 0;
      width: 100%;
      min-width: 800px;
      display: flex;
      padding: 0 10px;
      z-index: 2;
    }
    
    .key-spacer {
      flex: 1;
    }
    
    .key {
      position: relative;
      flex: 1;
      min-width: 50px;
      height: 220px;
      margin: 0 2px;
      border: 1px solid #999;
      border-radius: 0 0 5px 5px;
      background-color: var(--white-key-color);
      color: #555;
      cursor: pointer;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 10px;
      font-weight: bold;
      transition: all 0.1s;
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    }
    
    .key:active, .key.active {
      background-color: var(--white-key-active);
      transform: translateY(2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .black-key {
      width: 40px;
      height: 130px;
      background-color: var(--black-key-color);
      border-radius: 0 0 5px 5px;
      color: #ddd;
      cursor: pointer;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 10px;
      font-weight: bold;
      transition: all 0.1s;
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
      z-index: 2;
      margin: 0 2px;
    }
    
    .black-key:active, .black-key.active {
      background-color: var(--black-key-active);
      transform: translateY(2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    
    .instructions {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin: 30px 0;
      width: 100%;
      max-width: 800px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .instructions h2 {
      margin-bottom: 15px;
      color: #cca352;
    }
    
    .key-guide {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    
    .key-item {
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px 15px;
      border-radius: 4px;
      background-color: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .key-label {
      display: inline-block;
      background-color: #2e3852;
      padding: 3px 6px;
      margin-right: 5px;
      border-radius: 3px;
      font-family: monospace;
      font-weight: bold;
    }
    
    .demo-songs {
      margin-top: 10px;
    }
    
    .demo-song {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 8px 15px;
      margin: 5px 0;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .demo-song:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .octave-indicator {
      position: absolute;
      bottom: -30px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.7);
    }
    
    @media (max-width: 1200px) {
      .key {
        min-width: 40px;
        height: 200px;
      }
      .black-key {
        width: 30px;
        height: 120px;
      }
    }
    
    @media (max-width: 900px) {
      .key {
        min-width: 35px;
        height: 180px;
      }
      .black-key {
        width: 25px;
        height: 100px;
      }
    }
    
    @media (max-width: 600px) {
      .key {
        min-width: 30px;
        height: 160px;
        font-size: 0.8rem;
      }
      .black-key {
        width: 20px;
        height: 90px;
        font-size: 0.7rem;
      }
    }
    
    /* Thêm hiệu ứng ripple khi nhấn phím */
    .key::after, .black-key::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%, -50%);
      transform-origin: 50% 50%;
    }
    
    .key.active::after, .black-key.active::after {
      animation: ripple 0.6s ease-out;
    }
    
    @keyframes ripple {
      0% {
        opacity: 1;
        transform: scale(0, 0) translate(-50%, -50%);
      }
      100% {
        opacity: 0;
        transform: scale(20, 20) translate(-50%, -50%);
      }
    }
    
    /* Thêm hiệu ứng cho tên nốt nhạc */
    .note-display {
      font-size: 1.2rem;
      margin-bottom: 15px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .note-highlight {
      display: inline-block;
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      animation: fadeOut 1.5s forwards;
    }
    
    @keyframes fadeOut {
      0% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; }
    }
    
    /* Hiệu ứng cho nút record */
    .recording-indicator {
      position: relative;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #f44336;
      margin-right: 5px;
    }
    
    .recording .recording-indicator::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: rgba(244, 67, 54, 0.3);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(0.7);
        opacity: 1;
      }
      70% {
        transform: scale(1.2);
        opacity: 0;
      }
      100% {
        transform: scale(0.7);
        opacity: 0;
      }
    }
    
    /* Volume control */
    .volume-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 120px;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: #cca352;
      border-radius: 50%;
      cursor: pointer;
    }
    
    /* Logo/brand styling */
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }
    
    .brand-logo {
      font-size: 2rem;
      color: #cca352;
    }
    
    /* Footer styling */
    footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.6);
    }

    .visualizer-container {
      width: 100%;
      max-width: 1200px;
      height: 100px;
      margin: 20px 0;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      overflow: hidden;
    }

    #visualizer {
      width: 100%;
      height: 100%;
    }

    .theme-dark {
      --white-key-color: #f0f0f0;
      --white-key-active: #d0d0d0;
      --black-key-color: #111;
      --black-key-active: #333;
      --piano-border: #996633;
      --wood-color: #5c3a21;
      background: linear-gradient(135deg, #0a0a1a, #0d1b2a, #1b263b);
    }

    .theme-light {
      --white-key-color: #ffffff;
      --white-key-active: #e0e0e0;
      --black-key-color: #000000;
      --black-key-active: #333333;
      --piano-border: #996633;
      --wood-color: #8B4513;
      background: linear-gradient(135deg, #f5f7fa, #e4e8f0, #d3d9e3);
      color: #333;
    }

    /* Thêm các hiệu ứng mới */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s;
    }
    
    .loading-screen.fade-out {
      opacity: 0;
    }
    
    .loading-content {
      text-align: center;
      color: white;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #cca352;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .visual-feedback {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      pointer-events: none;
    }
    
    .visual-feedback.press {
      background: rgba(255, 255, 255, 0.3);
      animation: press-feedback 0.5s ease-out;
    }
    
    .visual-feedback.release {
      background: rgba(255, 255, 255, 0.2);
      animation: release-feedback 0.5s ease-out;
    }
    
    .visual-feedback.volume {
      background: rgba(204, 163, 82, 0.3);
      animation: volume-feedback 0.5s ease-out;
    }
    
    .visual-feedback.octave {
      background: rgba(204, 163, 82, 0.3);
      animation: octave-feedback 0.5s ease-out;
    }
    
    @keyframes press-feedback {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
    }
    
    @keyframes release-feedback {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
    }
    
    @keyframes volume-feedback {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
    }
    
    @keyframes octave-feedback {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
    }
    
    /* Cải thiện hiệu ứng cho các phím đàn */
    .key, .black-key {
      position: relative;
      overflow: hidden;
      transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .key::before, .black-key::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .key:hover::before, .black-key:hover::before {
      opacity: 1;
    }
    
    .key.active, .black-key.active {
      transform: translateY(2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Cải thiện hiệu ứng cho các nút điều khiển */
    button {
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }
    
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255,255,255,0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%, -50%);
      transform-origin: 50% 50%;
    }
    
    button:active::after {
      animation: ripple 0.6s ease-out;
    }
    
    /* Cải thiện hiệu ứng cho visualizer */
    .visualizer-container {
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .visualizer-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      pointer-events: none;
    }
    
    /* Thêm hiệu ứng cho note display */
    .note-display {
      position: relative;
      overflow: hidden;
    }
    
    .note-highlight {
      position: relative;
      display: inline-block;
      padding: 5px 15px;
      background: rgba(204, 163, 82, 0.2);
      border-radius: 20px;
      animation: note-fade 1.5s forwards;
    }
    
    @keyframes note-fade {
      0% { transform: scale(0.8); opacity: 0; }
      20% { transform: scale(1.1); opacity: 1; }
      80% { opacity: 1; }
      100% { transform: scale(1); opacity: 0; }
    }
    
    /* Thêm hiệu ứng cho controls */
    .controls {
      position: relative;
      background: rgba(255, 255, 255, 0.1);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .control-group {
      position: relative;
    }
    
    .control-group::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(204, 163, 82, 0.5), transparent);
      transform: scaleX(0);
      transition: transform 0.3s;
    }
    
    .control-group:hover::after {
      transform: scaleX(1);
    }
    
    /* Thêm hiệu ứng cho piano container */
    .piano-container {
      transform-style: preserve-3d;
      perspective: 1000px;
    }
    
    .piano {
      transform: rotateX(5deg);
      transition: transform 0.3s;
    }
    
    .piano:hover {
      transform: rotateX(3deg);
    }
    
    /* Thêm hiệu ứng cho theme toggle */
    .theme-toggle {
      position: relative;
      overflow: hidden;
    }
    
    .theme-toggle i {
      transition: transform 0.5s;
    }
    
    .theme-toggle:hover i {
      transform: rotate(180deg);
    }
    
    /* Thêm hiệu ứng cho volume control */
    input[type="range"] {
      position: relative;
      overflow: hidden;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      transition: transform 0.2s;
    }
    
    input[type="range"]:hover::-webkit-slider-thumb {
      transform: scale(1.2);
    }
    
    /* Thêm hiệu ứng cho demo songs */
    .demo-song {
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }
    
    .demo-song::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .demo-song:hover::before {
      left: 100%;
    }
    
    .demo-song:hover {
      transform: translateX(5px);
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* Thêm hiệu ứng cho metronome */
    .metronome-active .recording-indicator {
      animation: metronome-pulse 1s infinite;
    }
    
    @keyframes metronome-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    /* Thêm hiệu ứng cho upload button */
    #upload-midi {
      position: relative;
      overflow: hidden;
    }
    
    #upload-midi::before {
      content: '';
      position: absolute;
      top: -100%;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(0deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: top 0.5s;
    }
    
    #upload-midi:hover::before {
      top: 100%;
    }

    /* Thêm style cho thông báo */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 5px;
      transform: translateX(150%);
      transition: transform 0.3s ease-in-out;
      z-index: 1000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification i {
      font-size: 1.2em;
    }

    .notification.info i {
      color: #2196F3;
    }

    .notification.success i {
      color: #4CAF50;
    }

    .notification.error i {
      color: #f44336;
    }

    /* Cải thiện hiệu ứng visualizer */
    .visualizer-container {
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      background: linear-gradient(45deg, rgba(0,0,0,0.2), rgba(0,0,0,0.4));
    }

    .visualizer-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      pointer-events: none;
    }

    #visualizer {
      width: 100%;
      height: 100%;
      filter: blur(1px);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="brand">
        <div class="brand-logo"><i class="fas fa-music"></i></div>
        <h1>VirtualPiano Pro</h1>
      </div>
      <p>Chơi đàn piano cao cấp trên trình duyệt web</p>
    </header>
    
    <div class="controls">
      <div class="control-group">
        <span class="control-label">Âm sắc:</span>
        <select id="instrument-select" title="Chọn âm sắc">
          <option value="piano">Piano</option>
          <option value="bright_piano">Piano Sáng</option>
          <option value="electric_piano">Piano Điện</option>
          <option value="synth">Synthesizer</option>
          <option value="strings">Đàn Dây</option>
        </select>
      </div>
      
      <div class="control-group volume-control">
        <span class="control-label"><i class="fas fa-volume-up"></i></span>
        <input type="range" id="volume" min="0" max="1" step="0.01" value="0.7" title="Điều chỉnh âm lượng">
      </div>
      
      <div class="control-group">
        <button id="octave-down"><i class="fas fa-angle-left"></i> Octave</button>
        <button id="octave-up">Octave <i class="fas fa-angle-right"></i></button>
      </div>
      
      <div class="control-group">
        <button id="record-button" class="record-btn">
          <div class="recording-indicator"></div>Ghi âm
        </button>
        <button id="play-button" disabled><i class="fas fa-play"></i> Phát</button>
        <button id="stop-button" disabled><i class="fas fa-stop"></i> Dừng</button>
        <button id="save-button" disabled><i class="fas fa-save"></i> Lưu</button>
        <button id="load-button"><i class="fas fa-folder-open"></i> Tải</button>
        <input type="file" id="load-file" accept=".json" style="display: none">
      </div>
      
      <div class="control-group">
        <button id="metronome-button"><i class="fas fa-stopwatch"></i> Nhịp</button>
        <input type="range" id="tempo" min="40" max="200" value="120" title="Điều chỉnh tempo">
        <span id="tempo-display">120 BPM</span>
      </div>

      <div class="control-group">
        <button id="theme-toggle"><i class="fas fa-moon"></i> Theme</button>
        <button id="upload-midi"><i class="fas fa-upload"></i> MIDI</button>
        <input type="file" id="midi-file" accept=".mid,.midi" style="display: none">
      </div>

      <div class="control-group">
        <select id="song-select" title="Chọn bài hát demo">
          <option value="">Chọn bài hát...</option>
        </select>
        <button id="play-demo"><i class="fas fa-play"></i> Phát/Dừng</button>
      </div>
    </div>
    
    <div class="note-display"></div>
    
    <div class="piano-container">
      <div class="piano-top"></div>
      <div class="piano">
        <div class="white-keys">
          <div class="key" data-note="C" data-key="a">C</div>
          <div class="key" data-note="D" data-key="s">D</div>
          <div class="key" data-note="E" data-key="d">E</div>
          <div class="key" data-note="F" data-key="f">F</div>
          <div class="key" data-note="G" data-key="g">G</div>
          <div class="key" data-note="A" data-key="h">A</div>
          <div class="key" data-note="B" data-key="j">B</div>
          <div class="key" data-note="C2" data-key="k">C</div>
          <div class="key" data-note="D2" data-key="l">D</div>
          <div class="key" data-note="E2" data-key=";">E</div>
          <div class="key" data-note="F2" data-key="'">F</div>
          <div class="key" data-note="G2" data-key="\\">G</div>
        </div>
        
        <div class="black-keys">
          <div class="key-spacer" style="width: 45px;"></div>
          <div class="black-key" data-note="C#" data-key="w">C#</div>
          <div class="key-spacer" style="width: 30px;"></div>
          <div class="black-key" data-note="D#" data-key="e">D#</div>
          <div class="key-spacer" style="width: 65px;"></div>
          <div class="black-key" data-note="F#" data-key="t">F#</div>
          <div class="key-spacer" style="width: 30px;"></div>
          <div class="black-key" data-note="G#" data-key="y">G#</div>
          <div class="key-spacer" style="width: 30px;"></div>
          <div class="black-key" data-note="A#" data-key="u">A#</div>
          <div class="key-spacer" style="width: 65px;"></div>
          <div class="black-key" data-note="C#2" data-key="o">C#</div>
          <div class="key-spacer" style="width: 30px;"></div>
          <div class="black-key" data-note="D#2" data-key="p">D#</div>
        </div>
      </div>
      <div class="octave-indicator">
        <span>Octave: <span id="octave-display">4</span></span>
      </div>
    </div>
    
    <div class="instructions">
      <h2>Hướng dẫn sử dụng</h2>
      <p>Bạn có thể chơi đàn piano bằng nhiều cách:</p>
      <ul>
        <li>Nhấp chuột vào các phím đàn</li>
        <li>Sử dụng bàn phím máy tính để chơi các nốt tương ứng</li>
        <li>Thử các demo bài hát được cung cấp sẵn</li>
      </ul>
      
      <h3 style="margin-top: 15px;">Bàn phím</h3>
      <div class="key-guide">
        <div class="key-item"><span class="key-label">A</span> C</div>
        <div class="key-item"><span class="key-label">W</span> C#</div>
        <div class="key-item"><span class="key-label">S</span> D</div>
        <div class="key-item"><span class="key-label">E</span> D#</div>
        <div class="key-item"><span class="key-label">D</span> E</div>
        <div class="key-item"><span class="key-label">F</span> F</div>
        <div class="key-item"><span class="key-label">T</span> F#</div>
        <div class="key-item"><span class="key-label">G</span> G</div>
        <div class="key-item"><span class="key-label">Y</span> G#</div>
        <div class="key-item"><span class="key-label">H</span> A</div>
        <div class="key-item"><span class="key-label">U</span> A#</div>
        <div class="key-item"><span class="key-label">J</span> B</div>
        <div class="key-item"><span class="key-label">K</span> C</div>
        <div class="key-item"><span class="key-label">O</span> C#</div>
        <div class="key-item"><span class="key-label">L</span> D</div>
        <div class="key-item"><span class="key-label">P</span> D#</div>
        <div class="key-item"><span class="key-label">;</span> E</div>
        <div class="key-item"><span class="key-label">'</span> F</div>
        <div class="key-item"><span class="key-label">\</span> G</div>
      </div>
    </div>

    <div class="visualizer-container">
      <canvas id="visualizer"></canvas>
    </div>
  </div>
  
  <footer>
    <p>© 2025 VirtualPiano Pro - Được tạo bởi devthm cho Anh Thu</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
  // Khởi tạo các biến toàn cục
  let audioContext;
  let masterGainNode;
  let currentOctave = 4;
  const noteDisplay = document.querySelector('.note-display');
  const octaveDisplay = document.getElementById('octave-display');
  const volumeControl = document.getElementById('volume');
  const instrumentSelect = document.getElementById('instrument-select');
  const recordButton = document.getElementById('record-button');
  const playButton = document.getElementById('play-button');
  const stopButton = document.getElementById('stop-button');
  const metronomeButton = document.getElementById('metronome-button');
  const tempoControl = document.getElementById('tempo');
  const octaveDownBtn = document.getElementById('octave-down');
  const octaveUpBtn = document.getElementById('octave-up');
  const tempoDisplay = document.getElementById('tempo-display');
  let isRecording = false;
  let recordedNotes = [];
  let startRecordTime = 0;
  let isPlaying = false;
  let metronomeActive = false;
  let metronomeInterval;
  let metronomeCount = 0;
  
  // Thêm các biến mới
  let analyser;
  let visualizerCtx;
  let isDarkTheme = false;
  let midiFile;
  let activeNotes = {};
  let keyMap = {};
  
  // Ánh xạ tên nốt đến tần số
  const noteFrequencies = {
    'C': 261.63,
    'C#': 277.18,
    'D': 293.66,
    'D#': 311.13,
    'E': 329.63,
    'F': 349.23,
    'F#': 369.99,
    'G': 392.00,
    'G#': 415.30,
    'A': 440.00,
    'A#': 466.16,
    'B': 493.88
  };
  
  // Các tham số âm sắc
  const instruments = {
    'piano': {
      type: 'triangle',
      attack: 0.001,
      decay: 0.15,
      sustain: 0.5,
      release: 0.4
    },
    'bright_piano': {
      type: 'triangle',
      attack: 0.001,
      decay: 0.1,
      sustain: 0.6,
      release: 0.3
    },
    'electric_piano': {
      type: 'triangle',
      attack: 0.005,
      decay: 0.2,
      sustain: 0.4,
      release: 0.2
    },
    'synth': {
      type: 'triangle',
      attack: 0.02,
      decay: 0.15,
      sustain: 0.7,
      release: 0.2
    },
    'strings': {
      type: 'triangle',
      attack: 0.05,
      decay: 0.3,
      sustain: 0.8,
      release: 0.3
    }
  };
  
  // Tạo pool các oscillators để tái sử dụng
  const oscillatorPool = {
    pool: [],
    maxSize: 100,
    get() {
      if (this.pool.length > 0) {
        return this.pool.pop();
      }
      return null;
    },
    release(osc) {
      if (this.pool.length < this.maxSize) {
        this.pool.push(osc);
      }
    }
  };

  // Tạo pool các gain nodes
  const gainNodePool = {
    pool: [],
    maxSize: 100,
    get() {
      if (this.pool.length > 0) {
        return this.pool.pop();
      }
      return null;
    },
    release(gainNode) {
      if (this.pool.length < this.maxSize) {
        this.pool.push(gainNode);
      }
    }
  };

  // Tạo shared compressor và convolver
  let sharedCompressor;
  let sharedConvolver;

  function initSharedNodes() {
    if (!sharedCompressor) {
      sharedCompressor = audioContext.createDynamicsCompressor();
      sharedCompressor.threshold.value = -24;
      sharedCompressor.knee.value = 30;
      sharedCompressor.ratio.value = 12;
      sharedCompressor.attack.value = 0.003;
      sharedCompressor.release.value = 0.25;
    }

    if (!sharedConvolver) {
      sharedConvolver = audioContext.createConvolver();
      createReverb(sharedConvolver, 1.2, 0.4);
    }

    sharedCompressor.connect(sharedConvolver);
    sharedConvolver.connect(masterGainNode);
  }
  
  // Khởi tạo Audio Context khi người dùng tương tác
  function initAudio() {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      masterGainNode = audioContext.createGain();
      masterGainNode.connect(audioContext.destination);
      masterGainNode.gain.value = volumeControl.value;
      
      // Khởi tạo visualizer
      initVisualizer();
      
      // Khởi tạo các demo bài hát
      initDemoSongs();
    }
  }

  // Thêm hiệu ứng visual feedback
  function addVisualFeedback(element, type = 'press') {
    const feedback = document.createElement('div');
    feedback.className = `visual-feedback ${type}`;
    element.appendChild(feedback);
    
    setTimeout(() => {
      feedback.remove();
    }, 500);
  }

  // Cập nhật khi thay đổi âm lượng
  volumeControl.addEventListener('input', function() {
    if (masterGainNode) {
      masterGainNode.gain.value = this.value;
      addVisualFeedback(this.parentElement, 'volume');
    }
  });
  
  // Thay đổi octave
  octaveDownBtn.addEventListener('click', function() {
    if (currentOctave > 1) {
      currentOctave--;
      octaveDisplay.textContent = currentOctave;
      addVisualFeedback(this, 'octave');
    }
  });
  
  octaveUpBtn.addEventListener('click', function() {
    if (currentOctave < 7) {
      currentOctave++;
      octaveDisplay.textContent = currentOctave;
      addVisualFeedback(this, 'octave');
    }
  });
  
  // Ghi âm
  recordButton.addEventListener('click', function() {
    if (!isRecording) {
      startRecording();
    } else {
      stopRecording();
    }
  });
  
  function startRecording() {
    isRecording = true;
    recordedNotes = [];
    startRecordTime = Date.now();
    recordButton.classList.add('recording');
    playButton.disabled = true;
    stopButton.disabled = true;
  }
  
  function stopRecording() {
    isRecording = false;
    recordButton.classList.remove('recording');
    playButton.disabled = false;
    stopButton.disabled = false;
  }
  
  // Phát ghi âm
  playButton.addEventListener('click', function() {
    if (!isPlaying && recordedNotes.length > 0) {
      playRecording();
    }
  });
  
  stopButton.addEventListener('click', function() {
    stopPlayback();
  });
  
  function playRecording() {
    if (!audioContext) initAudio();
    
    isPlaying = true;
    playButton.disabled = true;
    stopButton.disabled = false;
    recordButton.disabled = true;
    
    let startTime = audioContext.currentTime;
    
    // Lặp qua tất cả các nốt ghi âm và phát lại
    recordedNotes.forEach(note => {
      const timeOffset = note.time / 1000; // Chuyển đổi từ ms sang giây
      const noteTime = startTime + timeOffset;
      const duration = note.duration / 1000;
      
      playNoteAtTime(note.note, note.octave, noteTime, duration);
      
      // Hiệu ứng hiển thị trên phím
      setTimeout(() => {
        const element = findKeyElement(note.note);
        if (element) {
          element.classList.add('active');
          setTimeout(() => {
            element.classList.remove('active');
          }, duration * 1000);
        }
      }, timeOffset * 1000);
    });
    
    // Tính toán tổng thời gian của bản ghi âm
    if (recordedNotes.length > 0) {
      const lastNote = recordedNotes[recordedNotes.length - 1];
      const totalDuration = (lastNote.time + lastNote.duration) / 1000 + 0.5;
      
      setTimeout(() => {
        stopPlayback();
      }, totalDuration * 1000);
    }
  }
  
  function findKeyElement(noteName) {
    // Tìm phần tử DOM của phím đàn dựa trên tên nốt
    return document.querySelector(`[data-note="${noteName}"]`);
  }
  
  function stopPlayback() {
    isPlaying = false;
    playButton.disabled = false;
    stopButton.disabled = true;
    recordButton.disabled = false;
  }
  
  // Metronome
  metronomeButton.addEventListener('click', function() {
    if (!metronomeActive) {
      startMetronome();
    } else {
      stopMetronome();
    }
  });
  
  function startMetronome() {
    if (!audioContext) initAudio();
    
    metronomeActive = true;
    metronomeButton.classList.add('active');
    metronomeCount = 0;
    
    const tempo = parseInt(tempoControl.value);
    const interval = 60000 / tempo; // Chuyển BPM thành milliseconds
    
    metronomeInterval = setInterval(() => {
      playMetronomeClick(metronomeCount % 4 === 0);
      metronomeCount++;
    }, interval);
  }
  
  function stopMetronome() {
    metronomeActive = false;
    metronomeButton.classList.remove('active');
    clearInterval(metronomeInterval);
  }
  
  function playMetronomeClick(isAccent) {
    const osc = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    osc.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // Âm thanh cao cho các nhịp mạnh, thấp cho các nhịp yếu
    osc.frequency.value = isAccent ? 1000 : 800;
    gainNode.gain.value = isAccent ? 0.2 : 0.1;
    
    osc.start();
    osc.stop(audioContext.currentTime + 0.05);
    
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.05);
  }
  
  // Xử lý sự kiện bàn phím và chuột
  function initKeyboardEvents() {
    const keys = document.querySelectorAll('.key, .black-key');
    
    keys.forEach(key => {
      const note = key.getAttribute('data-note');
      const keyPress = key.getAttribute('data-key');
      keyMap[keyPress] = { element: key, note: note };
      
      // Xử lý sự kiện chuột
      key.addEventListener('mousedown', () => {
        initAudio();
        const noteOctave = getNoteOctave(note);
        playNote(note, noteOctave, key);
        addVisualFeedback(key, 'press');
      });
      
      key.addEventListener('mouseup', () => {
        stopNote(key);
        addVisualFeedback(key, 'release');
      });
      
      key.addEventListener('mouseleave', () => {
        stopNote(key);
      });
      
      // Xử lý sự kiện touch
      key.addEventListener('touchstart', (e) => {
        e.preventDefault();
        initAudio();
        const noteOctave = getNoteOctave(note);
        playNote(note, noteOctave, key);
        addVisualFeedback(key, 'press');
      });
      
      key.addEventListener('touchend', (e) => {
        e.preventDefault();
        stopNote(key);
        addVisualFeedback(key, 'release');
      });
    });
    
    // Xử lý sự kiện bàn phím
    document.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      
      initAudio();
      
      const key = e.key.toLowerCase();
      if (keyMap[key]) {
        const noteInfo = keyMap[key];
        const noteOctave = getNoteOctave(noteInfo.note);
        playNote(noteInfo.note, noteOctave, noteInfo.element);
        addVisualFeedback(noteInfo.element, 'press');
      }
    });
    
    document.addEventListener('keyup', (e) => {
      const key = e.key.toLowerCase();
      if (keyMap[key]) {
        stopNote(keyMap[key].element);
        addVisualFeedback(keyMap[key].element, 'release');
      }
    });
  }
  
  // Chuyển đổi từ tên nốt sang octave
  function getNoteOctave(note) {
    if (note.includes('2')) {
      return currentOctave + 1;
    } else {
      return currentOctave;
    }
  }
  
  // Chuyển đổi tên nốt thành tên cơ bản (bỏ số)
  function getBasicNoteName(noteName) {
    return noteName.replace(/[0-9]/g, '');
  }
  
  // Hiển thị nốt nhạc đang phát
  function displayPlayedNote(note) {
    const basicNote = getBasicNoteName(note);
    noteDisplay.innerHTML = `<span class="note-highlight">${basicNote}</span>`;
  }
  
  // Phát âm thanh nốt nhạc
  function playNote(note, octave, element) {
    if (!audioContext) initAudio();
    
    // Nếu nốt đang được phát, dừng nó trước
    if (activeNotes[note]) {
      stopNote(element);
    }
    
    element.classList.add('active');
    displayPlayedNote(note);
    
    const cleanNote = getBasicNoteName(note);
    const freq = calculateFrequency(cleanNote, octave);
    const instrumentType = instrumentSelect.value;
    const instrument = instruments[instrumentType];
    const startTime = audioContext.currentTime;
    const noteId = startTime.toString();
    
    // Tạo oscillator và gain node
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    // Cấu hình oscillator
    oscillator.type = instrument.type;
    oscillator.frequency.value = freq;
    
    // Thêm detune nhẹ để tạo hiệu ứng tự nhiên
    oscillator.detune.value = Math.random() * 10 - 5;
    
    // Kết nối các node
    oscillator.connect(gainNode);
    gainNode.connect(masterGainNode);
    
    // Áp dụng ADSR envelope
    const now = audioContext.currentTime;
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(1, now + instrument.attack);
    gainNode.gain.linearRampToValueAtTime(instrument.sustain, now + instrument.attack + instrument.decay);
    
    // Bắt đầu phát âm thanh
    oscillator.start();
    
    // Lưu thông tin cho việc dừng nốt
    activeNotes[note] = {
      oscillator: oscillator,
      gainNode: gainNode,
      startTime: startTime,
      id: noteId
    };
    
    if (isRecording) {
      const noteTime = Date.now() - startRecordTime;
      recordedNotes.push({
        note: note,
        octave: octave,
        time: noteTime,
        duration: 0,
        id: noteId
      });
    }
  }
  
  function playNoteAtTime(note, octave, startTime, duration) {
    const cleanNote = getBasicNoteName(note);
    const freq = calculateFrequency(cleanNote, octave);
    
    const instrumentType = instrumentSelect.value;
    const instrument = instruments[instrumentType];
    
    // Tạo các node âm thanh
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    // Kết nối các node
    oscillator.connect(gainNode);
    gainNode.connect(masterGainNode);
    
    // Cấu hình oscillator
    oscillator.type = instrument.type;
    oscillator.frequency.value = freq;
    
    // Áp dụng ADSR envelope
    gainNode.gain.setValueAtTime(0, startTime);
    gainNode.gain.linearRampToValueAtTime(1, startTime + instrument.attack);
    gainNode.gain.linearRampToValueAtTime(instrument.sustain, startTime + instrument.attack + instrument.decay);
    gainNode.gain.setValueAtTime(instrument.sustain, startTime + duration - instrument.release);
    gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
    
    // Phát âm thanh
    oscillator.start(startTime);
    oscillator.stop(startTime + duration + 0.1);
    
    // Hiển thị nốt
    setTimeout(() => displayPlayedNote(note), (startTime - audioContext.currentTime) * 1000);
  }
  
  // Tối ưu hóa việc tạo reverb
  function createReverb(convolverNode, duration, decay) {
    const sampleRate = audioContext.sampleRate;
    const length = Math.min(sampleRate * duration, 44100); // Giới hạn độ dài tối đa
    const impulse = audioContext.createBuffer(2, length, sampleRate);
    
    const leftChannel = impulse.getChannelData(0);
    const rightChannel = impulse.getChannelData(1);
    
    for (let i = 0; i < length; i++) {
      const n = i / length;
      const value = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
      leftChannel[i] = value;
      rightChannel[i] = value * 0.8; // Thêm một chút stereo
    }
    
    convolverNode.buffer = impulse;
  }
  
  // Dừng phát nốt nhạc
  function stopNote(element) {
    try {
      element.classList.remove('active');
      
      const note = element.getAttribute('data-note');
      const activeNote = activeNotes[note];
      
      if (activeNote) {
        const now = audioContext.currentTime;
        const instrumentType = instrumentSelect.value;
        const releaseTime = instruments[instrumentType].release;
        
        // Áp dụng giai đoạn release
        activeNote.gainNode.gain.cancelScheduledValues(now);
        activeNote.gainNode.gain.setValueAtTime(activeNote.gainNode.gain.value, now);
        activeNote.gainNode.gain.exponentialRampToValueAtTime(0.001, now + releaseTime);
        
        // Dừng oscillator sau khi release kết thúc
        setTimeout(() => {
          try {
            if (activeNote.oscillator) {
              activeNote.oscillator.stop();
              activeNote.oscillator.disconnect();
            }
            if (activeNote.gainNode) {
              activeNote.gainNode.disconnect();
            }
          } catch (error) {
            console.error('Lỗi dọn dẹp nốt nhạc:', error);
          }
        }, releaseTime * 1000);
        
        if (isRecording) {
          const noteTime = Date.now() - startRecordTime;
          const recordedNote = recordedNotes.find(n => n.note === note && n.duration === 0);
          if (recordedNote) {
            recordedNote.duration = noteTime - recordedNote.time;
          }
        }
        
        delete activeNotes[note];
      }
    } catch (error) {
      console.error('Lỗi dừng nốt nhạc:', error);
    }
  }
  
  // Tính toán tần số của nốt nhạc
  function calculateFrequency(note, octave) {
    const baseFreq = noteFrequencies[note];
    if (!baseFreq) return 440; // Mặc định là A4
    
    // Điều chỉnh theo octave (chuẩn là octave 4)
    return baseFreq * Math.pow(2, octave - 4);
  }
  
  // Khởi tạo các bài hát demo
  function initDemoSongs() {
    const demoSongs = {
      'happy-birthday': [
        { note: 'C', duration: 0.6, wait: 0 },
        { note: 'C', duration: 0.4, wait: 0.2 },
        { note: 'D', duration: 0.6, wait: 0.2 },
        { note: 'C', duration: 0.6, wait: 0.2 },
        { note: 'F', duration: 0.6, wait: 0.2 },
        { note: 'E', duration: 1.2, wait: 0.4 },
        { note: 'C', duration: 0.6, wait: 0.2 },
        { note: 'C', duration: 0.4, wait: 0.2 },
        { note: 'D', duration: 0.6, wait: 0.2 },
        { note: 'C', duration: 0.6, wait: 0.2 },
        { note: 'G', duration: 0.6, wait: 0.2 },
        { note: 'F', duration: 1.2, wait: 0.4 },
        { note: 'C', duration: 0.6, wait: 0.2 },
        { note: 'C', duration: 0.4, wait: 0.2 },
        { note: 'C2', duration: 0.6, wait: 0.2 },
        { note: 'A', duration: 0.6, wait: 0.2 },
        { note: 'F', duration: 0.6, wait: 0.2 },
        { note: 'E', duration: 0.6, wait: 0.2 },
        { note: 'D', duration: 1.2, wait: 0.4 },
        { note: 'A#', duration: 0.6, wait: 0.2 },
        { note: 'A#', duration: 0.4, wait: 0.2 },
        { note: 'A', duration: 0.6, wait: 0.2 },
        { note: 'F', duration: 0.6, wait: 0.2 },
        { note: 'G', duration: 0.6, wait: 0.2 },
        { note: 'F', duration: 1.2, wait: 0.4 }
      ],
      'twinkle-twinkle': [
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'A', duration: 0.4, wait: 0.1 },
        { note: 'A', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.8, wait: 0.2 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.8, wait: 0.2 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.8, wait: 0.2 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.8, wait: 0.2 },
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'A', duration: 0.4, wait: 0.1 },
        { note: 'A', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.8, wait: 0.2 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.8, wait: 0.2 }
      ],
      'jingle-bells': [
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.8, wait: 0.2 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.8, wait: 0.2 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.6, wait: 0.2 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 1.6, wait: 0.4 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.8, wait: 0.2 },
        { note: 'G', duration: 0.8, wait: 0.2 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.8, wait: 0.2 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.8, wait: 0.2 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.6, wait: 0.2 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 1.6, wait: 0.4 }
      ],
      'ode-to-joy': [
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.8, wait: 0.2 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'D', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'C', duration: 0.8, wait: 0.2 }
      ],
      'fur-elise': [
        { note: 'E', duration: 0.3, wait: 0.1 },
        { note: 'D#', duration: 0.3, wait: 0.1 },
        { note: 'E', duration: 0.3, wait: 0.1 },
        { note: 'D#', duration: 0.3, wait: 0.1 },
        { note: 'E', duration: 0.3, wait: 0.1 },
        { note: 'B', duration: 0.3, wait: 0.1 },
        { note: 'D', duration: 0.3, wait: 0.1 },
        { note: 'C', duration: 0.3, wait: 0.1 },
        { note: 'A', duration: 0.6, wait: 0.2 },
        { note: 'C', duration: 0.3, wait: 0.1 },
        { note: 'E', duration: 0.6, wait: 0.2 },
        { note: 'A', duration: 0.6, wait: 0.2 },
        { note: 'B', duration: 0.6, wait: 0.2 },
        { note: 'E', duration: 0.3, wait: 0.1 },
        { note: 'G#', duration: 0.3, wait: 0.1 },
        { note: 'B', duration: 0.6, wait: 0.2 },
        { note: 'C2', duration: 0.6, wait: 0.2 },
        { note: 'E', duration: 0.3, wait: 0.1 },
        { note: 'D#', duration: 0.3, wait: 0.1 },
        { note: 'E', duration: 0.3, wait: 0.1 },
        { note: 'D#', duration: 0.3, wait: 0.1 },
        { note: 'E', duration: 0.3, wait: 0.1 },
        { note: 'B', duration: 0.3, wait: 0.1 },
        { note: 'D', duration: 0.3, wait: 0.1 },
        { note: 'C', duration: 0.3, wait: 0.1 },
        { note: 'A', duration: 0.6, wait: 0.2 },
        { note: 'C', duration: 0.3, wait: 0.1 },
        { note: 'E', duration: 0.6, wait: 0.2 },
        { note: 'A', duration: 0.6, wait: 0.2 },
        { note: 'B', duration: 0.6, wait: 0.2 },
        { note: 'E', duration: 0.3, wait: 0.1 },
        { note: 'C', duration: 0.3, wait: 0.1 },
        { note: 'B', duration: 0.6, wait: 0.2 },
        { note: 'A', duration: 0.6, wait: 0.2 }
      ],
      'noi-nay-co-anh': [
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.4, wait: 0.1 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'G2', duration: 0.4, wait: 0.1 },
        { note: 'C3', duration: 0.8, wait: 0.2 },
        { note: 'B2', duration: 0.4, wait: 0.1 },
        { note: 'A2', duration: 0.4, wait: 0.1 },
        { note: 'G2', duration: 0.4, wait: 0.1 },
        { note: 'F2', duration: 0.4, wait: 0.1 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'D2', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.8, wait: 0.2 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'A', duration: 0.4, wait: 0.1 },
        { note: 'B', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.4, wait: 0.1 },
        { note: 'D2', duration: 0.4, wait: 0.1 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'F2', duration: 0.8, wait: 0.2 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'D2', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.4, wait: 0.1 },
        { note: 'B', duration: 0.4, wait: 0.1 },
        { note: 'A', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.8, wait: 0.2 }
      ],
      'tuy-am': [
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.4, wait: 0.1 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'G2', duration: 0.4, wait: 0.1 },
        { note: 'C3', duration: 0.8, wait: 0.2 },
        { note: 'B2', duration: 0.4, wait: 0.1 },
        { note: 'A2', duration: 0.4, wait: 0.1 },
        { note: 'G2', duration: 0.4, wait: 0.1 },
        { note: 'F2', duration: 0.4, wait: 0.1 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'D2', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.8, wait: 0.2 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'A', duration: 0.4, wait: 0.1 },
        { note: 'B', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.4, wait: 0.1 },
        { note: 'D2', duration: 0.4, wait: 0.1 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'F2', duration: 0.8, wait: 0.2 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'D2', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.4, wait: 0.1 },
        { note: 'B', duration: 0.4, wait: 0.1 },
        { note: 'A', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.8, wait: 0.2 }
      ],
      'dom-dom': [
        { note: 'C', duration: 0.4, wait: 0.1 },
        { note: 'E', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.4, wait: 0.1 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'G2', duration: 0.4, wait: 0.1 },
        { note: 'C3', duration: 0.8, wait: 0.2 },
        { note: 'B2', duration: 0.4, wait: 0.1 },
        { note: 'A2', duration: 0.4, wait: 0.1 },
        { note: 'G2', duration: 0.4, wait: 0.1 },
        { note: 'F2', duration: 0.4, wait: 0.1 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'D2', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.8, wait: 0.2 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'A', duration: 0.4, wait: 0.1 },
        { note: 'B', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.4, wait: 0.1 },
        { note: 'D2', duration: 0.4, wait: 0.1 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'F2', duration: 0.8, wait: 0.2 },
        { note: 'E2', duration: 0.4, wait: 0.1 },
        { note: 'D2', duration: 0.4, wait: 0.1 },
        { note: 'C2', duration: 0.4, wait: 0.1 },
        { note: 'B', duration: 0.4, wait: 0.1 },
        { note: 'A', duration: 0.4, wait: 0.1 },
        { note: 'G', duration: 0.4, wait: 0.1 },
        { note: 'F', duration: 0.8, wait: 0.2 }
      ]
    };
    
    // Thêm các bài hát vào select
    const songSelect = document.getElementById('song-select');
    songSelect.innerHTML = '<option value="">Chọn bài hát...</option>';
    
    Object.keys(demoSongs).forEach(songName => {
      const option = document.createElement('option');
      option.value = songName;
      option.textContent = songName.split('-').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
      songSelect.appendChild(option);
    });
    
    // Lưu các bài hát vào biến toàn cục
    window.demoSongs = demoSongs;
  }
  
  // Khởi tạo visualizer
  function initVisualizer() {
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;
    masterGainNode.connect(analyser);
    
    const canvas = document.getElementById('visualizer');
    visualizerCtx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    function drawVisualizer() {
      requestAnimationFrame(drawVisualizer);
      
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);
      
      visualizerCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
      visualizerCtx.fillRect(0, 0, canvas.width, canvas.height);
      
      const barWidth = (canvas.width / bufferLength) * 2.5;
      let x = 0;
      
      for (let i = 0; i < bufferLength; i++) {
        const barHeight = (dataArray[i] / 255) * canvas.height;
        
        // Tạo gradient màu dựa trên tần số và âm lượng
        const gradient = visualizerCtx.createLinearGradient(0, canvas.height - barHeight, 0, canvas.height);
        const hue = (i * 360 / bufferLength + Date.now() / 50) % 360;
        gradient.addColorStop(0, `hsla(${hue}, 100%, 50%, 0.8)`);
        gradient.addColorStop(1, `hsla(${hue}, 100%, 30%, 0.4)`);
        
        visualizerCtx.fillStyle = gradient;
        visualizerCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
        
        // Thêm hiệu ứng glow
        visualizerCtx.shadowColor = `hsla(${hue}, 100%, 50%, 0.5)`;
        visualizerCtx.shadowBlur = 10;
        visualizerCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
        visualizerCtx.shadowBlur = 0;
        
        x += barWidth + 1;
      }
      
      // Thêm hiệu ứng sóng
      visualizerCtx.beginPath();
      visualizerCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      visualizerCtx.lineWidth = 2;
      
      for (let i = 0; i < canvas.width; i++) {
        const y = canvas.height / 2 + Math.sin(i * 0.02 + Date.now() * 0.001) * 20;
        if (i === 0) {
          visualizerCtx.moveTo(i, y);
        } else {
          visualizerCtx.lineTo(i, y);
        }
      }
      
      visualizerCtx.stroke();
    }
    
    drawVisualizer();
  }

  // Thêm sự kiện cho nút lưu
  document.getElementById('save-button').addEventListener('click', function() {
    if (recordedNotes.length > 0) {
      const data = {
        notes: recordedNotes,
        instrument: instrumentSelect.value,
        tempo: document.getElementById('tempo').value
      };
      
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'piano-recording.json';
      a.click();
      URL.revokeObjectURL(url);
    }
  });

  // Thêm sự kiện cho nút theme
  document.getElementById('theme-toggle').addEventListener('click', function() {
    isDarkTheme = !isDarkTheme;
    document.body.classList.toggle('theme-dark', isDarkTheme);
    document.body.classList.toggle('theme-light', !isDarkTheme);
    this.innerHTML = isDarkTheme ? '<i class="fas fa-sun"></i> Theme' : '<i class="fas fa-moon"></i> Theme';
  });

  // Thêm sự kiện cho nút upload MIDI
  document.getElementById('upload-midi').addEventListener('click', function() {
    document.getElementById('midi-file').click();
  });

  document.getElementById('midi-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        midiFile = e.target.result;
        // Xử lý file MIDI ở đây
        // Cần thêm thư viện MIDI.js hoặc tương tự
      };
      reader.readAsArrayBuffer(file);
    }
  });

  // Thêm sự kiện cho tempo control
  tempoControl.addEventListener('input', function() {
    tempoDisplay.textContent = this.value + ' BPM';
    if (metronomeActive) {
      stopMetronome();
      startMetronome();
    }
  });

  // Thêm sự kiện cho nút phát demo
  document.getElementById('play-demo').addEventListener('click', function() {
    if (isPlaying) {
      stopPlayback();
      this.innerHTML = '<i class="fas fa-play"></i> Phát/Dừng';
    } else {
      playDemoSong();
      this.innerHTML = '<i class="fas fa-stop"></i> Phát/Dừng';
    }
  });

  // Khởi tạo các sự kiện khi trang web load xong
  initKeyboardEvents();
  
  // Thêm hiệu ứng loading
  const loadingScreen = document.createElement('div');
  loadingScreen.className = 'loading-screen';
  loadingScreen.innerHTML = `
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Đang tải VirtualPiano Pro...</div>
    </div>
  `;
  document.body.appendChild(loadingScreen);
  
  // Xóa loading screen sau khi tải xong
  setTimeout(() => {
    loadingScreen.classList.add('fade-out');
    setTimeout(() => {
      loadingScreen.remove();
    }, 500);
  }, 1000);

  // Phát bài hát demo
  function playDemoSong() {
    try {
      if (!audioContext) initAudio();
      
      const songName = document.getElementById('song-select').value;
      if (!songName) {
        alert('Vui lòng chọn một bài hát demo.');
        return;
      }
      
      const song = window.demoSongs[songName];
      if (!song) {
        alert('Không tìm thấy bài hát demo.');
        return;
      }
      
      isPlaying = true;
      playButton.disabled = true;
      stopButton.disabled = false;
      recordButton.disabled = true;
      
      let startTime = audioContext.currentTime;
      let currentTime = 0;
      
      song.forEach(note => {
        try {
          const noteTime = startTime + currentTime;
          const duration = note.duration;
          
          // Tạo và phát nốt nhạc
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.type = instruments[instrumentSelect.value].type;
          oscillator.frequency.value = calculateFrequency(note.note, currentOctave);
          
          oscillator.connect(gainNode);
          gainNode.connect(masterGainNode);
          
          // Áp dụng ADSR envelope
          gainNode.gain.setValueAtTime(0, noteTime);
          gainNode.gain.linearRampToValueAtTime(1, noteTime + 0.01);
          gainNode.gain.linearRampToValueAtTime(0.7, noteTime + 0.1);
          gainNode.gain.setValueAtTime(0.7, noteTime + duration - 0.1);
          gainNode.gain.linearRampToValueAtTime(0, noteTime + duration);
          
          oscillator.start(noteTime);
          oscillator.stop(noteTime + duration);
          
          // Hiển thị nốt đang phát
          setTimeout(() => {
            try {
              const element = findKeyElement(note.note);
              if (element) {
                element.classList.add('active');
                displayPlayedNote(note.note);
              }
            } catch (error) {
              console.error('Lỗi hiển thị nốt nhạc:', error);
            }
          }, (noteTime - audioContext.currentTime) * 1000);
          
          setTimeout(() => {
            try {
              const element = findKeyElement(note.note);
              if (element) {
                element.classList.remove('active');
              }
            } catch (error) {
              console.error('Lỗi ẩn nốt nhạc:', error);
            }
          }, (noteTime + duration - audioContext.currentTime) * 1000);
          
          currentTime += note.wait + note.duration;
        } catch (error) {
          console.error('Lỗi phát nốt nhạc trong bài hát demo:', error);
        }
      });
      
      // Dừng phát sau khi bài hát kết thúc
      setTimeout(() => {
        try {
          stopPlayback();
        } catch (error) {
          console.error('Lỗi dừng phát bài hát demo:', error);
        }
      }, currentTime * 1000 + 1000);
    } catch (error) {
      console.error('Lỗi phát bài hát demo:', error);
      alert('Có lỗi xảy ra khi phát bài hát demo. Vui lòng thử lại.');
      stopPlayback();
    }
  }
  
  // Dừng phát bài hát
  function stopPlayback() {
    isPlaying = false;
    playButton.disabled = false;
    stopButton.disabled = true;
    recordButton.disabled = false;
    
    // Dừng tất cả các nốt đang phát
    Object.keys(activeNotes).forEach(note => {
      const element = findKeyElement(note);
      if (element) {
        stopNote(element);
      }
    });
  }

  // Thêm hiệu ứng thông báo
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <div class="notification-content">
        <i class="fas ${type === 'info' ? 'fa-info-circle' : type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <span>${message}</span>
      </div>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        notification.remove();
      }, 300);
    }, 3000);
  }

  // Thêm sự kiện cho các nút điều khiển
  document.querySelectorAll('button, select, input[type="range"]').forEach(element => {
    element.addEventListener('click', function() {
      const title = this.getAttribute('title');
      if (title) {
        showNotification(title, 'info');
      }
    });
  });
});

    </script>
  </body>
</html>
